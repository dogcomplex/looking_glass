<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LookingGlassSim Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
    h2 { margin: 0 0 8px 0; font-size: 18px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #eee; padding: 6px 8px; text-align: left; font-size: 12px; }
    .score { font-weight: bold; }
    canvas { width: 100% !important; height: 280px !important; }
    .diagram { display: flex; align-items: center; justify-content: center; }
    .box { padding: 6px 10px; border: 1px solid #999; border-radius: 4px; margin: 4px; font-size: 12px; }
    .arrow { margin: 0 6px; font-size: 16px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>LookingGlassSim Results</h1>
  <p>Run: <code>python examples/test.py --json out/test_summary.json</code> then open this page and select the JSON.</p>

  <input type="file" id="file" accept="application/json" />
  <div style="margin:8px 0;">
    <button id="btn-run" title="Run examples/test.py with the selected options">Run Retest</button>
    <button id="btn-run-matrix" title="Run 2x2x2 matrix (input x sensitivity x output) and optional windows">Run Matrix</button>
    <label style="margin-left:8px;" title="Number of trials per configuration; higher = more stable p50">
      Trials <input id="inp-trials" type="number" value="300" style="width:80px;"/>
    </label>
    <label style="margin-left:8px;" title="Seed for RNG; controls reproducibility">
      Seed <input id="inp-seed" type="number" value="123" style="width:80px;"/>
    </label>
    <label style="margin-left:8px;" title="Base exposure/integration window for the pipeline (ns)">
      Base Window ns <input id="inp-window" type="number" value="20" step="0.5" style="width:80px;"/>
    </label>
    <label style="margin-left:8px;" title="Temporal voting (repeat=3) to reduce BER by majority vote">
      <input id="chk-vote" type="checkbox" checked/> Vote3
    </label>
    <label style="margin-left:8px;" title="Search realistic parameter bounds to lower BER (clock, TIA, comparator, optics, etc)">
      <input id="chk-autotune" type="checkbox" checked/> Autotune
    </label>
    <label style="margin-left:8px;" title="Use lower TIA BW and comparator noise to magnify trends in sweeps">
      <input id="chk-sens" type="checkbox"/> Sensitivity
    </label>
    <label style="margin-left:8px;" title="Enable neighbor/diagonal crosstalk model (vs global pedestal)">
      <input id="chk-neigh" type="checkbox"/> Neighbor CT
    </label>
    <label style="margin-left:8px;" title="Include Path B baseline (SA+amp enabled)">
      <input id="chk-pathb" type="checkbox" checked/> Path B baseline
    </label>
    <label style="margin-left:8px;" title="Number of cascaded Path B stages (discrete re-threshold per stage)">
      Path B depth <input id="inp-pathb-depth" type="number" value="5" min="0" max="8" style="width:60px;"/>
    </label>
    <label style="margin-left:8px;" title="Run Path B gain and SA I_sat sweeps to see BER envelopes">
      <input id="chk-pathb-sweep" type="checkbox" checked/> Path B sweeps
    </label>
    <label style="margin-left:8px;" title="Integrate multiple input frames until dv exceeds threshold+margin (up to Max frames)">
      <input id="chk-adapt" type="checkbox" checked/> Adaptive input
    </label>
    <label style="margin-left:8px;" title="Max frames the input stage is allowed to integrate before propagating">
      Max frames <input id="inp-adapt-max" type="number" value="12" min="1" max="16" style="width:60px;"/>
    </label>
    <label style="margin-left:8px;" title="Extra decision margin above the comparator up-threshold (mV)">
      Margin mV <input id="inp-adapt-margin" type="number" value="0.8" step="0.1" style="width:60px;"/>
    </label>
    <label style="margin-left:8px;" title="Run true analog cascade (optics-only hops with single final threshold)">
      <input id="chk-pathb-analog" type="checkbox" checked/> Path B analog cascade
    </label>
    <label style="margin-left:8px;" title="Run cold-storage input baseline in parallel">
      <input id="chk-cold" type="checkbox" checked/> Cold input
    </label>
  </div>
  <div class="card" style="margin:8px 0;">
    <h2>Worker Log</h2>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
      <span>Connection:</span>
      <span id="conn" style="width:10px;height:10px;border-radius:50%;background:#f44336;display:inline-block;"></span>
      <span id="connText" style="font-size:12px;color:#555;">Inactive</span>
    </div>
    <pre id="log" style="white-space:pre-wrap;height:160px;overflow:auto;border:1px solid #eee;padding:8px;"></pre>
  </div>

  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h2>Summary KPIs</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
        <label title="Choose which variant's KPIs to display in Summary">
          Variant
          <select id="variant-select" style="min-width:220px;"></select>
        </label>
      </div>
      <table id="table-summary"></table>
    </div>
    <div class="card">
      <h2>Variants (click to focus)</h2>
      <div id="variant-bar" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
      <h2>Path A vs Path B</h2>
      <table id="table-paths"></table>
    </div>
    <div class="card">
      <h2>Input Path Comparison</h2>
      <table id="table-inputs"></table>
    </div>
    <div class="card">
      <h2>Realism Heuristics</h2>
      <table id="table-realism"></table>
    </div>
    <div class="card">
      <h2>Per-Component BER Attribution</h2>
      <table id="table-components"></table>
    </div>
    <div class="card">
      <h2>Calibrated Baseline KPIs</h2>
      <table id="table-calibrated"></table>
    </div>
    <div class="card">
      <h2>Per-tile BER</h2>
      <canvas id="tileHeat"></canvas>
    </div>
    <div class="card">
      <h2>Per-tile BER (after calibration)</h2>
      <canvas id="tileHeatAfter"></canvas>
    </div>
    <div class="card">
      <h2>Window Sweep (p50 BER)</h2>
      <canvas id="winChart"></canvas>
    </div>
    <div class="card">
      <h2>Voting & Calibration</h2>
      <table id="table-calib"></table>
    </div>
    <div class="card">
      <h2>Diag Crosstalk Sweep</h2>
      <canvas id="diagChart"></canvas>
    </div>
    <div class="card">
      <h2>Drift vs Time</h2>
      <canvas id="driftChart"></canvas>
    </div>
    <div class="card">
      <h2>Autotuner Result</h2>
      <table id="table-autotune"></table>
    </div>
    <div class="card">
      <h2>Best-of (across Matrix Runs)</h2>
      <table id="table-bestof"></table>
    </div>
    <div class="card">
      <h2>System Diagram</h2>
      <div class="diagram">
        <div class="box">Emitter</div><div class="arrow">→</div>
        <div class="box">Optics</div><div class="arrow">→</div>
        <div class="box">Camera</div><div class="arrow">→</div>
        <div class="box">TIA</div><div class="arrow">→</div>
        <div class="box">Comparator</div>
      </div>
      <p style="font-size:12px;color:#555;">Clock controls window & jitter. Thermal drift perturbs comparator threshold and optics transmittance.</p>
    </div>
    <div class="card">
      <h2>Pack Parameters</h2>
      <table id="table-packs"></table>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    let winChart, diagChart, driftChart, tileChartA, tileChartB;
    let collectedRuns = [];

    function getRunLabel(run) {
      try {
        const L = run.__label || {};
        const input = L.input ?? (run?.config?.input || 'digital');
        const sens = (L.sensitivity === true || L.sensitivity === 1) ? '1' : '0';
        const output = L.output ?? (run?.path_b ? 'path_b_analog' : 'path_a');
        const win = (L.window_ns ?? run?.baseline?.window_ns ?? run?.window_ns ?? '').toString();
        const depth = (L.analog_depth ?? run?.path_b?.analog_depth ?? '');
        const depthStr = depth !== '' ? ` / depth=${depth}` : '';
        return `${input} / sens=${sens} / ${output} / win=${win}${depthStr}`;
      } catch { return 'run'; }
    }

    function extractPrimaryBer(run) {
      try {
        const out = run.__label?.output;
        if (out === 'path_a') {
          return run?.path_a?.p50_ber ?? run?.baseline?.p50_ber ?? run?.p50_ber ?? null;
        }
        if (out === 'path_b_analog') {
          return run?.path_b?.analog_p50_ber ?? run?.path_b?.p50_ber ?? run?.baseline?.p50_ber ?? null;
        }
        // fallback
        return run?.baseline?.p50_ber ?? run?.p50_ber ?? null;
      } catch { return null; }
    }

    function updateBestOf() {
      const rows = [];
      if (!Array.isArray(collectedRuns) || collectedRuns.length === 0) {
        document.getElementById('table-bestof').innerHTML = '';
        return;
      }
      let bestOverall = { ber: Infinity, label: '' };
      let bestPathA = { ber: Infinity, label: '' };
      let bestPathB = { ber: Infinity, label: '' };
      let bestCold = { ber: Infinity, label: '' };
      let bestDigital = { ber: Infinity, label: '' };

      for (const r of collectedRuns) {
        const label = getRunLabel(r);
        const ber = extractPrimaryBer(r);
        if (typeof ber === 'number') {
          if (ber < bestOverall.ber) bestOverall = { ber, label };
        }
        const out = r.__label?.output;
        const inp = r.__label?.input;
        const berA = r?.path_a?.p50_ber ?? r?.baseline?.p50_ber;
        const berB = r?.path_b?.analog_p50_ber ?? r?.path_b?.p50_ber;
        if (typeof berA === 'number' && berA < bestPathA.ber) bestPathA = { ber: berA, label };
        if (typeof berB === 'number' && berB < bestPathB.ber) bestPathB = { ber: berB, label };
        if (inp === 'cold' && typeof ber === 'number' && ber < bestCold.ber) bestCold = { ber, label };
        if (inp === 'digital' && typeof ber === 'number' && ber < bestDigital.ber) bestDigital = { ber, label };
      }

      const table = document.getElementById('table-bestof');
      const obj = {
        best_overall_p50_ber: bestOverall.ber === Infinity ? 'N/A' : bestOverall.ber,
        best_overall_label: bestOverall.label || 'N/A',
        best_path_a_p50_ber: bestPathA.ber === Infinity ? 'N/A' : bestPathA.ber,
        best_path_a_label: bestPathA.label || 'N/A',
        best_path_b_analog_p50_ber: bestPathB.ber === Infinity ? 'N/A' : bestPathB.ber,
        best_path_b_analog_label: bestPathB.label || 'N/A',
        best_cold_input_p50_ber: bestCold.ber === Infinity ? 'N/A' : bestCold.ber,
        best_cold_input_label: bestCold.label || 'N/A',
        best_digital_input_p50_ber: bestDigital.ber === Infinity ? 'N/A' : bestDigital.ber,
        best_digital_input_label: bestDigital.label || 'N/A',
      };
      renderTable(table, obj);
    }

    function safeDestroy(ch) {
      try { if (ch && typeof ch.destroy === 'function') ch.destroy(); } catch (e) {}
    }

    function renderTable(table, obj) {
      const keys = Object.keys(obj || {});
      let html = '<tr><th>Key</th><th>Value</th></tr>';
      for (const k of keys) {
        let v = obj[k];
        if (typeof v === 'object') v = JSON.stringify(v);
        html += `<tr><td>${k}</td><td>${v}</td></tr>`;
      }
      table.innerHTML = html;
    }

    function renderPacks(table, packs) {
      let html = '<tr><th>Pack</th><th>Params</th></tr>';
      for (const [name, vals] of Object.entries(packs || {})) {
        html += `<tr><td>${name}</td><td><pre style="white-space:pre-wrap;">${JSON.stringify(vals, null, 2)}</pre></td></tr>`;
      }
      table.innerHTML = html;
    }

    function drawHeatmap(canvas, existingChart, matrix) {
      if (!matrix || !Array.isArray(matrix) || matrix.length === 0 || !Array.isArray(matrix[0])) {
        return existingChart || null;
      }
      safeDestroy(existingChart);
      // Flatten matrix into dataset per row; color via gradient plugin surrogate (Chart.js lacks heatmap natively)
      // We'll approximate using stacked bar per column with opacity by value.
      const labels = matrix[0].map((_, i) => 'x'+i);
      const datasets = matrix.map((row, r) => ({
        label: 'y'+r,
        data: row,
        backgroundColor: row.map(v => `rgba(33,150,243,${Math.min(1, Math.max(0.05, v))})`),
        borderWidth: 0
      }));
      const chart = new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          scales: { x: { stacked: true }, y: { stacked: true, suggestedMax: 1.0 } },
          plugins: { legend: { display: false } }
        }
      });
      return chart;
    }

    function drawLine(canvas, existingChart, xs, ys, label) {
      if (!Array.isArray(xs) || !Array.isArray(ys) || xs.length === 0 || ys.length === 0) {
        return existingChart || null;
      }
      safeDestroy(existingChart);
      const chart = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: { labels: xs, datasets: [{ label, data: ys, borderColor: '#4caf50', fill: false }] },
        options: { responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 1 } } }
      });
      return chart;
    }

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          renderTable(document.getElementById('table-summary'), {
            p50_ber: data?.baseline?.p50_ber,
            p50_energy_pj: data?.baseline?.p50_energy_pj,
            window_ns: data?.baseline?.window_ns,
            p50_snr_emit: data?.baseline?.p50_snr_emit,
            p50_snr_pd: data?.baseline?.p50_snr_pd,
            p50_snr_tia: data?.baseline?.p50_snr_tia,
          });
          renderTable(document.getElementById('table-realism'), (data?.realism)||{});
          renderTable(document.getElementById('table-components'), (data?.components)||{});
          const variants = [];
          variants.push({ key:'baseline', label:'Baseline (Digital, Path A)', present: !!data?.baseline });
          variants.push({ key:'cold_input', label:'Cold input (Path A)', present: !!data?.cold_input });
          variants.push({ key:'path_b', label:'Path B (baseline)', present: !!data?.path_b });
          variants.push({ key:'path_b_analog', label:'Path B (analog cascade)', present: !!data?.path_b?.analog_p50_ber });
          const bar = document.getElementById('variant-bar');
          bar.innerHTML = '';
          const sel = document.getElementById('variant-select');
          sel.innerHTML = '';
          const present = variants.filter(v=>v.present);
          present.forEach(v => {
            const b = document.createElement('button');
            b.textContent = v.label;
            b.style.padding = '4px 8px';
            b.onclick = () => {
              window.__focusVariant = v.key;
              // re-render summary tables according to selected variant if needed
              let base = null;
              if (v.key === 'cold_input') base = data?.cold_input;
              else if (v.key === 'path_b' || v.key === 'path_b_analog') base = data?.path_b;
              else base = data?.baseline;
              if (base) renderTable(document.getElementById('table-summary'), {
                p50_ber: base?.p50_ber ?? 'N/A',
                p50_energy_pj: base?.p50_energy_pj ?? 'N/A',
                window_ns: base?.window_ns ?? 'N/A',
                p50_snr_emit: base?.p50_snr_emit ?? 'N/A',
                p50_snr_pd: base?.p50_snr_pd ?? 'N/A',
                p50_snr_tia: base?.p50_snr_tia ?? 'N/A',
              });
            };
            bar.appendChild(b);
            const opt = document.createElement('option');
            opt.value = v.key;
            opt.textContent = v.label;
            sel.appendChild(opt);
          });
          if (present.length) {
            sel.onchange = () => {
              const key = sel.value;
              window.__focusVariant = key;
              let base = null;
              if (key === 'cold_input') base = data?.cold_input;
              else if (key === 'path_b' || key === 'path_b_analog') base = data?.path_b;
              else base = data?.baseline;
              if (base) renderTable(document.getElementById('table-summary'), {
                p50_ber: base?.p50_ber ?? 'N/A',
                p50_energy_pj: base?.p50_energy_pj ?? 'N/A',
                window_ns: base?.window_ns ?? 'N/A',
                p50_snr_emit: base?.p50_snr_emit ?? 'N/A',
                p50_snr_pd: base?.p50_snr_pd ?? 'N/A',
                p50_snr_tia: base?.p50_snr_tia ?? 'N/A',
              });
            };
            sel.value = present[0].key;
            sel.onchange();
          }
          if (data?.path_a || data?.path_b) {
            renderTable(document.getElementById('table-paths'), {
              path_a_p50_ber: data?.path_a?.p50_ber ?? 'N/A',
              path_b_p50_ber: data?.path_b?.p50_ber ?? 'N/A',
              path_b_chain_depth: data?.path_b_chain?.depth,
              path_b_chain_p50_ber_vs_prev: data?.path_b_chain?.per_stage_p50_ber_vs_prev,
              path_b_chain_p50_ber_vs_initial: data?.path_b_chain?.per_stage_p50_ber_vs_initial,
              path_b_sweep_amp_gain_db: data?.path_b_sweeps?.amp_gain_db,
              path_b_sweep_p50_ber_vs_gain: data?.path_b_sweeps?.p50_ber_vs_gain,
              path_b_sweep_sat_I_sat: data?.path_b_sweeps?.sat_I_sat,
              path_b_sweep_p50_ber_vs_isat: data?.path_b_sweeps?.p50_ber_vs_isat,
            });
          }
          if (data?.cold_input || data?.baseline) {
            renderTable(document.getElementById('table-inputs'), {
              dlp_input_p50_ber: data?.baseline?.p50_ber ?? 'N/A',
              cold_input_p50_ber: data?.cold_input?.p50_ber ?? 'N/A',
              cold_input_window_ns: data?.cold_input?.window_ns ?? 'N/A',
            });
          }
          renderTable(document.getElementById('table-calibrated'), {
            p50_ber: data?.baseline_calibrated?.p50_ber,
            p50_energy_pj: data?.baseline_calibrated?.p50_energy_pj,
            window_ns: data?.baseline_calibrated?.window_ns,
            p50_snr_emit: data?.baseline_calibrated?.p50_snr_emit,
            p50_snr_pd: data?.baseline_calibrated?.p50_snr_pd,
            p50_snr_tia: data?.baseline_calibrated?.p50_snr_tia,
          });
          renderPacks(document.getElementById('table-packs'), data?.packs || {});
          try {
            const hm = data?.ber_per_tile;
            tileChartA = drawHeatmap(document.getElementById('tileHeat'), tileChartA, hm);
          } catch {}
          try {
            const hma = data?.ber_per_tile_after;
            tileChartB = drawHeatmap(document.getElementById('tileHeatAfter'), tileChartB, hma);
          } catch {}
          try {
            const xs = data?.window_sweep?.x_window_ns || [];
            const ys = data?.window_sweep?.p50_ber || [];
            winChart = drawLine(document.getElementById('winChart'), winChart, xs, ys, 'p50 BER');
          } catch {}
          try {
            const dx = data?.sensitivity?.diag_crosstalk_sweep?.x_ct_diag_db || [];
            const dy = data?.sensitivity?.diag_crosstalk_sweep?.p50_ber || [];
            diagChart = drawLine(document.getElementById('diagChart'), diagChart, dx, dy, 'p50 BER vs ct_diag_db');
          } catch {}
          const dno = data?.drift?.no_cal || {};
          const dfix = data?.drift?.with_cal || {};
          if ((dno?.x_frame?.length||0) && (dfix?.x_frame?.length||0)) {
            const ctx = document.getElementById('driftChart').getContext('2d');
            safeDestroy(driftChart);
            driftChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: dno.x_frame,
                datasets: [
                  { label: 'No Cal', data: dno.p50_ber, borderColor: '#f44336', fill: false },
                  { label: 'With Cal', data: dfix.p50_ber, borderColor: '#2196f3', fill: false }
                ]
              },
              options: { responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 1 } } }
            });
          }
          renderTable(document.getElementById('table-calib'), {
            vote3_p50_ber: data?.vote3_p50_ber,
            spatial_oversample_p50_ber: data?.spatial_oversample_p50_ber,
            lockin_p50_ber: data?.lockin_p50_ber,
            chop_p50_ber: data?.chop_p50_ber,
            avg_frames_p50_ber: data?.avg_frames_p50_ber,
            soft_thresh_p50_ber: data?.soft_thresh_p50_ber,
            mitigated_p50_ber: data?.mitigated_p50_ber,
            vth_suggest_mV: data?.calibration?.vth_suggest_mV,
            ber_before: data?.calibration?.ber_before,
            ber_after: data?.calibration?.ber_after,
            ber_delta: data?.calibration?.ber_delta,
          });
          if (data?.autotune) {
            renderTable(document.getElementById('table-autotune'), {
              best_ber: data.autotune.best_ber,
              best_summary: JSON.stringify(data.autotune.best_summary),
              tuned_clock_window_ns: data.autotune.params?.clock?.window_ns,
              tuned_emitter_power_mw_per_ch: data.autotune.params?.emitter?.power_mw_per_ch,
              tuned_tia_gain_kohm: data.autotune.params?.tia?.tia_transimpedance_kohm,
              tuned_tia_bw_mhz: data.autotune.params?.tia?.bw_mhz,
              tuned_comp_hysteresis_mV: data.autotune.params?.comparator?.hysteresis_mV,
              tuned_optics_ct_db: data.autotune.params?.optics?.crosstalk_db,
              tuned_optics_ct_neighbor_db: data.autotune.params?.optics?.ct_neighbor_db,
              tuned_optics_ct_diag_db: data.autotune.params?.optics?.ct_diag_db,
            });
          }
        } catch (err) {
          alert('Invalid JSON');
        }
      };
      reader.readAsText(f);
    });

    // Retest controls
    const logEl = document.getElementById('log');
    function appendLog(obj) {
      logEl.textContent += (typeof obj === 'string' ? obj : JSON.stringify(obj)) + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }
    const evtSrc = new EventSource('/api/events');
    evtSrc.onmessage = (ev) => {
      try {
        const data = JSON.parse(ev.data);
        if (data.msg === 'connected') {
          document.getElementById('conn').style.background = '#4caf50';
          document.getElementById('connText').textContent = 'Active';
          return;
        }
        if (data.ping) return; // quiet heartbeat
        appendLog(data);
      } catch { appendLog(ev.data); }
    };
    evtSrc.addEventListener('done', (ev) => {
      try {
        const data = JSON.parse(ev.data);
        if (data.__run_id) {
          // Matrix run result: collect and append to select, auto-render latest
          collectedRuns.push(data);
          const sel = document.getElementById('variant-select');
          const label = getRunLabel(data);
          const opt = document.createElement('option');
          opt.value = `run:${data.__run_id}`;
          opt.textContent = label;
          sel.appendChild(opt);
          sel.value = `run:${data.__run_id}`;
          // render immediately across panels
          renderTable(document.getElementById('table-summary'), {
            p50_ber: data?.baseline?.p50_ber ?? data?.p50_ber ?? 'N/A',
            p50_energy_pj: data?.baseline?.p50_energy_pj ?? data?.p50_energy_pj ?? 'N/A',
            window_ns: data?.baseline?.window_ns ?? data?.window_ns ?? 'N/A',
            p50_snr_emit: data?.baseline?.p50_snr_emit ?? data?.p50_snr_emit ?? 'N/A',
            p50_snr_pd: data?.baseline?.p50_snr_pd ?? data?.p50_snr_pd ?? 'N/A',
            p50_snr_tia: data?.baseline?.p50_snr_tia ?? data?.p50_snr_tia ?? 'N/A',
          });
          renderTable(document.getElementById('table-realism'), (data?.realism)||{});
          renderTable(document.getElementById('table-components'), (data?.components)||{});
          renderTable(document.getElementById('table-paths'), {
            path_a_p50_ber: data?.path_a?.p50_ber ?? 'N/A',
            path_b_p50_ber: data?.path_b?.p50_ber ?? 'N/A',
            path_b_chain_depth: data?.path_b_chain?.depth ?? 'N/A',
            path_b_chain_p50_ber_vs_prev: data?.path_b_chain?.per_stage_p50_ber_vs_prev ?? 'N/A',
            path_b_chain_p50_ber_vs_initial: data?.path_b_chain?.per_stage_p50_ber_vs_initial ?? 'N/A',
            path_b_analog_depth: data?.path_b?.analog_depth ?? 'N/A',
            path_b_analog_p50_ber: data?.path_b?.analog_p50_ber ?? 'N/A',
          });
          renderTable(document.getElementById('table-inputs'), {
            dlp_input_p50_ber: data?.baseline?.p50_ber ?? 'N/A',
            cold_input_p50_ber: data?.cold_input?.p50_ber ?? 'N/A',
            cold_input_window_ns: data?.cold_input?.window_ns ?? 'N/A',
          });
          renderTable(document.getElementById('table-calibrated'), {
            p50_ber: data?.baseline_calibrated?.p50_ber,
            p50_energy_pj: data?.baseline_calibrated?.p50_energy_pj,
            window_ns: data?.baseline_calibrated?.window_ns,
            p50_snr_emit: data?.baseline_calibrated?.p50_snr_emit,
            p50_snr_pd: data?.baseline_calibrated?.p50_snr_pd,
            p50_snr_tia: data?.baseline_calibrated?.p50_snr_tia,
          });
          // Packs
          try { renderPacks(document.getElementById('table-packs'), data?.packs || {}); } catch {}
          try { tileChartA = drawHeatmap(document.getElementById('tileHeat'), tileChartA, data?.ber_per_tile); } catch {}
          try { tileChartB = drawHeatmap(document.getElementById('tileHeatAfter'), tileChartB, data?.ber_per_tile_after); } catch {}
          try {
            const xs = data?.window_sweep?.x_window_ns || [];
            const ys = data?.window_sweep?.p50_ber || [];
            winChart = drawLine(document.getElementById('winChart'), winChart, xs, ys, 'p50 BER');
          } catch {}
          // Diag crosstalk sweep (sensitivity block)
          try {
            const dx = data?.sensitivity?.diag_crosstalk_sweep?.x_ct_diag_db || [];
            const dy = data?.sensitivity?.diag_crosstalk_sweep?.p50_ber || [];
            diagChart = drawLine(document.getElementById('diagChart'), diagChart, dx, dy, 'p50 BER vs ct_diag_db');
          } catch {}
          // Drift vs time
          try {
            const dno = data?.drift?.no_cal || {};
            const dfix = data?.drift?.with_cal || {};
            if ((dno?.x_frame?.length||0) && (dfix?.x_frame?.length||0)) {
              const ctx = document.getElementById('driftChart').getContext('2d');
              safeDestroy(driftChart);
              driftChart = new Chart(ctx, {
                type: 'line',
                data: { labels: dno.x_frame, datasets: [
                  { label: 'No Cal', data: dno.p50_ber, borderColor: '#f44336', fill: false },
                  { label: 'With Cal', data: dfix.p50_ber, borderColor: '#2196f3', fill: false },
                ]},
                options: { responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 1 } } }
              });
            }
          } catch {}
          // Autotuner results
          if (data?.autotune) {
            renderTable(document.getElementById('table-autotune'), {
              best_ber: data.autotune.best_ber,
              best_summary: JSON.stringify(data.autotune.best_summary),
              tuned_clock_window_ns: data.autotune.params?.clock?.window_ns,
              tuned_emitter_power_mw_per_ch: data.autotune.params?.emitter?.power_mw_per_ch,
              tuned_tia_gain_kohm: data.autotune.params?.tia?.tia_transimpedance_kohm,
              tuned_tia_bw_mhz: data.autotune.params?.tia?.bw_mhz,
              tuned_comp_hysteresis_mV: data.autotune.params?.comparator?.hysteresis_mV,
              tuned_optics_ct_db: data.autotune.params?.optics?.crosstalk_db,
              tuned_optics_ct_neighbor_db: data.autotune.params?.optics?.ct_neighbor_db,
              tuned_optics_ct_diag_db: data.autotune.params?.optics?.ct_diag_db,
            });
          }
          renderTable(document.getElementById('table-calib'), {
            vote3_p50_ber: data?.vote3_p50_ber,
            spatial_oversample_p50_ber: data?.spatial_oversample_p50_ber,
            lockin_p50_ber: data?.lockin_p50_ber,
            chop_p50_ber: data?.chop_p50_ber,
            avg_frames_p50_ber: data?.avg_frames_p50_ber,
            soft_thresh_p50_ber: data?.soft_thresh_p50_ber,
            mitigated_p50_ber: data?.mitigated_p50_ber,
            vth_suggest_mV: data?.calibration?.vth_suggest_mV,
            ber_before: data?.calibration?.ber_before,
            ber_after: data?.calibration?.ber_after,
            ber_delta: data?.calibration?.ber_delta,
          });
          // update best-of
          updateBestOf();
          return;
        }
        // Auto-load the finished JSON
        renderTable(document.getElementById('table-summary'), {
          p50_ber: data?.baseline?.p50_ber ?? 'N/A',
          p50_energy_pj: data?.baseline?.p50_energy_pj ?? 'N/A',
          window_ns: data?.baseline?.window_ns ?? 'N/A',
          p50_snr_emit: data?.baseline?.p50_snr_emit ?? 'N/A',
          p50_snr_pd: data?.baseline?.p50_snr_pd ?? 'N/A',
          p50_snr_tia: data?.baseline?.p50_snr_tia ?? 'N/A',
        });
        renderTable(document.getElementById('table-realism'), (data?.realism)||{});
        // Build/refresh variants bar
        const variants = [];
        variants.push({ key:'baseline', label:'Baseline (Digital, Path A)', present: !!data?.baseline });
        variants.push({ key:'cold_input', label:'Cold input (Path A)', present: !!data?.cold_input });
        variants.push({ key:'path_b', label:'Path B (baseline)', present: !!data?.path_b });
        variants.push({ key:'path_b_analog', label:'Path B (analog cascade)', present: !!data?.path_b?.analog_p50_ber });
        const bar = document.getElementById('variant-bar');
        bar.innerHTML = '';
        const sel = document.getElementById('variant-select');
        sel.innerHTML = '';
        const present = variants.filter(v=>v.present);
        present.forEach(v => {
          const b = document.createElement('button');
          b.textContent = v.label;
          b.style.padding = '4px 8px';
          b.onclick = () => {
            window.__focusVariant = v.key;
            const base = (v.key==='cold_input') ? data?.cold_input : data?.baseline;
            if (base) renderTable(document.getElementById('table-summary'), {
              p50_ber: base?.p50_ber ?? 'N/A',
              p50_energy_pj: base?.p50_energy_pj ?? 'N/A',
              window_ns: base?.window_ns ?? 'N/A',
              p50_snr_emit: base?.p50_snr_emit ?? 'N/A',
              p50_snr_pd: base?.p50_snr_pd ?? 'N/A',
              p50_snr_tia: base?.p50_snr_tia ?? 'N/A',
            });
          };
          bar.appendChild(b);
          const opt = document.createElement('option');
          opt.value = v.key;
          opt.textContent = v.label;
          sel.appendChild(opt);
        });
        if (present.length) {
          sel.onchange = () => {
            const key = sel.value;
            window.__focusVariant = key;
            const base = (key==='cold_input') ? data?.cold_input : data?.baseline;
            if (base) renderTable(document.getElementById('table-summary'), {
              p50_ber: base?.p50_ber ?? 'N/A',
              p50_energy_pj: base?.p50_energy_pj ?? 'N/A',
              window_ns: base?.window_ns ?? 'N/A',
              p50_snr_emit: base?.p50_snr_emit ?? 'N/A',
              p50_snr_pd: base?.p50_snr_pd ?? 'N/A',
              p50_snr_tia: base?.p50_snr_tia ?? 'N/A',
            });
          };
          sel.value = present[0].key;
          sel.onchange();
        }
        if (data?.path_a || data?.path_b) {
          renderTable(document.getElementById('table-paths'), {
            path_a_p50_ber: data?.path_a?.p50_ber ?? 'N/A',
            path_b_p50_ber: data?.path_b?.p50_ber ?? 'N/A',
            path_b_chain_depth: data?.path_b_chain?.depth ?? 'N/A',
            path_b_chain_p50_ber_vs_prev: data?.path_b_chain?.per_stage_p50_ber_vs_prev ?? 'N/A',
            path_b_chain_p50_ber_vs_initial: data?.path_b_chain?.per_stage_p50_ber_vs_initial ?? 'N/A',
            path_b_analog_depth: data?.path_b?.analog_depth ?? 'N/A',
            path_b_analog_p50_ber: data?.path_b?.analog_p50_ber ?? 'N/A',
            path_b_sweep_amp_gain_db: data?.path_b_sweeps?.amp_gain_db ?? 'N/A',
            path_b_sweep_p50_ber_vs_gain: data?.path_b_sweeps?.p50_ber_vs_gain ?? 'N/A',
            path_b_sweep_sat_I_sat: data?.path_b_sweeps?.sat_I_sat ?? 'N/A',
            path_b_sweep_p50_ber_vs_isat: data?.path_b_sweeps?.p50_ber_vs_isat ?? 'N/A',
          });
        }
        if (data?.cold_input || data?.baseline) {
          renderTable(document.getElementById('table-inputs'), {
            dlp_input_p50_ber: data?.baseline?.p50_ber ?? 'N/A',
            cold_input_p50_ber: data?.cold_input?.p50_ber ?? 'N/A',
            cold_input_window_ns: data?.cold_input?.window_ns ?? 'N/A',
          });
        }
        renderTable(document.getElementById('table-calibrated'), {
          p50_ber: data?.baseline_calibrated?.p50_ber,
          p50_energy_pj: data?.baseline_calibrated?.p50_energy_pj,
          window_ns: data?.baseline_calibrated?.window_ns,
          p50_snr_emit: data?.baseline_calibrated?.p50_snr_emit,
          p50_snr_pd: data?.baseline_calibrated?.p50_snr_pd,
          p50_snr_tia: data?.baseline_calibrated?.p50_snr_tia,
        });
        try {
          const hm = data?.ber_per_tile;
          tileChartA = drawHeatmap(document.getElementById('tileHeat'), tileChartA, hm);
        } catch {}
        try {
          const hma = data?.ber_per_tile_after;
          tileChartB = drawHeatmap(document.getElementById('tileHeatAfter'), tileChartB, hma);
        } catch {}
        try {
          const xs = data?.window_sweep?.x_window_ns || [];
          const ys = data?.window_sweep?.p50_ber || [];
          winChart = drawLine(document.getElementById('winChart'), winChart, xs, ys, 'p50 BER');
        } catch {}
        renderTable(document.getElementById('table-calib'), {
          vote3_p50_ber: data?.vote3_p50_ber,
          spatial_oversample_p50_ber: data?.spatial_oversample_p50_ber,
          lockin_p50_ber: data?.lockin_p50_ber,
          chop_p50_ber: data?.chop_p50_ber,
          avg_frames_p50_ber: data?.avg_frames_p50_ber,
          soft_thresh_p50_ber: data?.soft_thresh_p50_ber,
          mitigated_p50_ber: data?.mitigated_p50_ber,
          vth_suggest_mV: data?.calibration?.vth_suggest_mV,
          ber_before: data?.calibration?.ber_before,
          ber_after: data?.calibration?.ber_after,
          ber_delta: data?.calibration?.ber_delta,
        });
        if (data?.autotune) {
          renderTable(document.getElementById('table-autotune'), {
            best_ber: data.autotune.best_ber,
            tuned_clock_window_ns: data.autotune.params?.clock?.window_ns,
            tuned_emitter_power_mw_per_ch: data.autotune.params?.emitter?.power_mw_per_ch,
            tuned_tia_gain_kohm: data.autotune.params?.tia?.tia_transimpedance_kohm,
            tuned_tia_bw_mhz: data.autotune.params?.tia?.bw_mhz,
            tuned_comp_hysteresis_mV: data.autotune.params?.comparator?.hysteresis_mV,
            tuned_optics_ct_db: data.autotune.params?.optics?.crosstalk_db,
            tuned_optics_ct_neighbor_db: data.autotune.params?.optics?.ct_neighbor_db,
            tuned_optics_ct_diag_db: data.autotune.params?.optics?.ct_diag_db,
          });
        }
        try {
          const dx = data?.sensitivity?.diag_crosstalk_sweep?.x_ct_diag_db || [];
          const dy = data?.sensitivity?.diag_crosstalk_sweep?.p50_ber || [];
          diagChart = drawLine(document.getElementById('diagChart'), diagChart, dx, dy, 'p50 BER vs ct_diag_db');
        } catch {}
        const dno = data?.drift?.no_cal || {};
        const dfix = data?.drift?.with_cal || {};
        if ((dno?.x_frame?.length||0) && (dfix?.x_frame?.length||0)) {
          const ctx = document.getElementById('driftChart').getContext('2d');
          new Chart(ctx, { type: 'line', data: { labels: dno.x_frame, datasets: [ { label: 'No Cal', data: dno.p50_ber, borderColor: '#f44336', fill: false }, { label: 'With Cal', data: dfix.p50_ber, borderColor: '#2196f3', fill: false } ] }, options: { responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 1 } } } });
        }
      } catch (e) { appendLog({ error: String(e) }); }
    });
    document.getElementById('btn-run').onclick = async () => {
      const trials = document.getElementById('inp-trials').value;
      const seed = document.getElementById('inp-seed').value;
      const windowNs = document.getElementById('inp-window').value;
      const vote = document.getElementById('chk-vote').checked ? '1':'0';
      const auto = document.getElementById('chk-autotune').checked ? '1':'0';
      const sens = document.getElementById('chk-sens').checked ? '1':'0';
      const neigh = document.getElementById('chk-neigh').checked ? '1':'0';
      const pbd = document.getElementById('inp-pathb-depth').value || '0';
      const pbw = document.getElementById('chk-pathb-sweep').checked ? '1':'0';
      const pbad = pbd; // default analog depth mirrors discrete depth
      const pben = document.getElementById('chk-pathb').checked ? '1':'0';
      const adapt = document.getElementById('chk-adapt').checked ? '1':'0';
      const adaptMax = document.getElementById('inp-adapt-max').value || '12';
      const adaptMargin = document.getElementById('inp-adapt-margin').value || '0.8';
      const pba = document.getElementById('chk-pathb-analog').checked ? '1':'0';
      const cold = document.getElementById('chk-cold').checked ? '1':'0';
      appendLog({ msg: 'requesting run' });
      try {
        const r = await fetch(`/api/run?trials=${trials}&seed=${seed}&base_window_ns=${windowNs}&vote3=${vote}&autotune=${auto}&sensitivity=${sens}&neighbor_ct=${neigh}&path_b=${pben}&path_b_depth=${pbd}&path_b_sweep=${pbw}&path_b_analog_depth=${pbad}&path_b_analog=${pba}&cold_input=${cold}&adaptive_input=${adapt}&adaptive_max_frames=${adaptMax}&adaptive_margin_mV=${adaptMargin}`);
        appendLog(await r.json());
      } catch (err) { appendLog({ error: String(err) }); }
    };

    document.getElementById('btn-run-matrix').onclick = async () => {
      const trials = document.getElementById('inp-trials').value;
      const seed = document.getElementById('inp-seed').value;
      const windowNs = document.getElementById('inp-window').value;
      const pbd = document.getElementById('inp-pathb-depth').value || '5';
      const auto = document.getElementById('chk-autotune').checked ? '1':'0';
      // fixed sets for now (2x2x2): inputs(digital,cold), sensitivities(0,1), outputs(path_a,path_b_analog)
      const inputs = 'digital,cold';
      const sensitivities = '0,1';
      const outputs = 'path_a,path_b_analog';
      appendLog({ msg: 'requesting matrix run' });
      try {
        const r = await fetch(`/api/run_matrix?trials=${trials}&seed=${seed}&windows=${windowNs}&inputs=${inputs}&sensitivities=${sensitivities}&outputs=${outputs}&path_b_analog_depth=${pbd}&autotune=${auto}`);
        appendLog(await r.json());
      } catch (err) { appendLog({ error: String(err) }); }
    };

    // Allow selecting any collected matrix run from the dropdown later
    document.getElementById('variant-select').addEventListener('change', () => {
      const sel = document.getElementById('variant-select');
      const val = sel.value || '';
      if (!val.startsWith('run:')) return; // handled elsewhere for static variants
      const runId = val.slice(4);
      const data = collectedRuns.find(r => r.__run_id === runId);
      if (!data) return;
      renderTable(document.getElementById('table-summary'), {
        p50_ber: data?.baseline?.p50_ber ?? data?.p50_ber ?? 'N/A',
        p50_energy_pj: data?.baseline?.p50_energy_pj ?? data?.p50_energy_pj ?? 'N/A',
        window_ns: data?.baseline?.window_ns ?? data?.window_ns ?? 'N/A',
        p50_snr_emit: data?.baseline?.p50_snr_emit ?? data?.p50_snr_emit ?? 'N/A',
        p50_snr_pd: data?.baseline?.p50_snr_pd ?? data?.p50_snr_pd ?? 'N/A',
        p50_snr_tia: data?.baseline?.p50_snr_tia ?? data?.p50_snr_tia ?? 'N/A',
      });
      renderTable(document.getElementById('table-realism'), (data?.realism)||{});
      renderTable(document.getElementById('table-components'), (data?.components)||{});
      renderTable(document.getElementById('table-paths'), {
        path_a_p50_ber: data?.path_a?.p50_ber ?? 'N/A',
        path_b_p50_ber: data?.path_b?.p50_ber ?? 'N/A',
        path_b_chain_depth: data?.path_b_chain?.depth ?? 'N/A',
        path_b_chain_p50_ber_vs_prev: data?.path_b_chain?.per_stage_p50_ber_vs_prev ?? 'N/A',
        path_b_chain_p50_ber_vs_initial: data?.path_b_chain?.per_stage_p50_ber_vs_initial ?? 'N/A',
        path_b_analog_depth: data?.path_b?.analog_depth ?? 'N/A',
        path_b_analog_p50_ber: data?.path_b?.analog_p50_ber ?? 'N/A',
      });
      renderTable(document.getElementById('table-inputs'), {
        dlp_input_p50_ber: data?.baseline?.p50_ber ?? 'N/A',
        cold_input_p50_ber: data?.cold_input?.p50_ber ?? 'N/A',
        cold_input_window_ns: data?.cold_input?.window_ns ?? 'N/A',
      });
      renderTable(document.getElementById('table-calibrated'), {
        p50_ber: data?.baseline_calibrated?.p50_ber,
        p50_energy_pj: data?.baseline_calibrated?.p50_energy_pj,
        window_ns: data?.baseline_calibrated?.window_ns,
        p50_snr_emit: data?.baseline_calibrated?.p50_snr_emit,
        p50_snr_pd: data?.baseline_calibrated?.p50_snr_pd,
        p50_snr_tia: data?.baseline_calibrated?.p50_snr_tia,
      });
      try { tileChartA = drawHeatmap(document.getElementById('tileHeat'), tileChartA, data?.ber_per_tile); } catch {}
      try { tileChartB = drawHeatmap(document.getElementById('tileHeatAfter'), tileChartB, data?.ber_per_tile_after); } catch {}
      try {
        const xs = data?.window_sweep?.x_window_ns || [];
        const ys = data?.window_sweep?.p50_ber || [];
        winChart = drawLine(document.getElementById('winChart'), winChart, xs, ys, 'p50 BER');
      } catch {}
      renderTable(document.getElementById('table-calib'), {
        vote3_p50_ber: data?.vote3_p50_ber,
        spatial_oversample_p50_ber: data?.spatial_oversample_p50_ber,
        lockin_p50_ber: data?.lockin_p50_ber,
        chop_p50_ber: data?.chop_p50_ber,
        avg_frames_p50_ber: data?.avg_frames_p50_ber,
        soft_thresh_p50_ber: data?.soft_thresh_p50_ber,
        mitigated_p50_ber: data?.mitigated_p50_ber,
        vth_suggest_mV: data?.calibration?.vth_suggest_mV,
        ber_before: data?.calibration?.ber_before,
        ber_after: data?.calibration?.ber_after,
        ber_delta: data?.calibration?.ber_delta,
      });
      updateBestOf();
    });
  </script>
</body>
</html>

