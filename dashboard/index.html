<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LookingGlassSim Dashboard</title>
  <style>
    :root {
      --bg: #0f172a;      /* slate-900 */
      --card: #111827;    /* gray-900 */
      --card2: #0b1220;   /* deeper */
      --text: #e5e7eb;    /* gray-200 */
      --muted: #9ca3af;   /* gray-400 */
      --accent: #60a5fa;  /* blue-400 */
      --border: #1f2937;  /* gray-800 */
    }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; margin: 0; background: var(--bg); color: var(--text); }
    h1 { margin: 24px 24px 8px; font-size: 22px; font-weight: 600; color: var(--text); }
    p { margin: 0 24px 16px; color: var(--muted); }
    .container { padding: 0 24px 24px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: linear-gradient(180deg, var(--card), var(--card2)); border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.25); }
    h2 { margin: 0 0 10px 0; font-size: 16px; font-weight: 600; color: var(--text); }
    table { border-collapse: collapse; width: 100%; background: transparent; }
    th, td { border: 1px solid var(--border); padding: 6px 8px; text-align: left; font-size: 12px; color: var(--text); }
    th { background: rgba(96,165,250,0.08); }
    .score { font-weight: 600; color: var(--accent); }
    canvas { width: 100% !important; height: 280px !important; }
    .diagram { display: flex; align-items: center; justify-content: center; }
    .box { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; margin: 4px; font-size: 12px; background: #0b1220; }
    .arrow { margin: 0 6px; font-size: 16px; color: var(--muted); }
    select, input[type="number"], input[type="text"], button { background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 6px 8px; }
    select[multiple] { min-height: 96px; }
    button { cursor: pointer; background: linear-gradient(180deg, #1e3a8a, #1f2937); border-color: #1e40af; }
    button:hover { filter: brightness(1.1); }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background: rgba(96,165,250,0.15); color: var(--accent); font-size: 12px; margin-left: 6px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .col { display:flex; flex-direction:column; gap:6px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>LookingGlassSim Results</h1>
  <p>Run: <code>python examples/test.py --json out/test_summary.json</code> then open this page and select the JSON.</p>

  <input type="file" id="file" accept="application/json" />
  <div class="card" style="margin:8px 0;">
    <h2>Run Config (multi-select everything)</h2>
    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start;">
      <div class="col"><div class="label">Trials</div><select id="ms-trials" multiple size="6" style="min-width:120px;"></select></div>
      <div class="col"><div class="label">Seed</div><select id="ms-seed" multiple size="4" style="min-width:120px;"></select></div>
      <div class="col"><div class="label">Base Window ns</div><select id="ms-window" multiple size="8" style="min-width:120px;"></select></div>
      <div class="col"><div class="label">Input Source</div><select id="ms-input" multiple size="2" style="min-width:160px;"><option value="digital" selected>Digital Emitter (DLP)</option><option value="cold">Analog Input (Cold Reader)</option></select></div>
      <div class="col"><div class="label">Path</div><select id="ms-path" multiple size="2" style="min-width:160px;"><option value="path_a" selected>Path A (Camera/TIA/Comp)</option><option value="path_b_analog">Path B Analog Cascade</option></select></div>
      <div class="col"><div class="label">Path B Depth</div><select id="ms-pathb-depth" multiple size="6" style="min-width:100px;"></select></div>
      <div class="col"><div class="label">Vote3</div><select id="ms-vote3" multiple size="2" style="min-width:120px;"><option value="1" selected>on</option><option value="0">off</option></select></div>
      <div class="col"><div class="label">Autotune</div><select id="ms-autotune" multiple size="2" style="min-width:120px;"><option value="1" selected>on</option><option value="0">off</option></select></div>
      <div class="col"><div class="label">Sensitivity</div><select id="ms-sensitivity" multiple size="2" style="min-width:120px;"><option value="0" selected>off (default)</option><option value="1">on</option></select></div>
      <div class="col"><div class="label">Neighbor CT</div><select id="ms-neighbor" multiple size="2" style="min-width:120px;"><option value="0" selected>off</option><option value="1">on</option></select></div>
      <div class="col"><div class="label">Adaptive Input</div><select id="ms-adapt-flag" multiple size="2" style="min-width:120px;"><option value="1" selected>on</option><option value="0">off</option></select></div>
      <div class="col"><div class="label">Adaptive Max Frames</div><select id="ms-adapt-max" multiple size="6" style="min-width:120px;"></select></div>
      <div class="col"><div class="label">Margin mV</div><select id="ms-margin" multiple size="6" style="min-width:120px;"></select></div>
      <div class="col" style="gap:8px;"><div class="label">Actions</div><button id="btn-run" title="Run selected config(s)">Run Selected</button><button id="btn-run-matrix" title="Run Cartesian matrix of selections" style="margin-left:8px;">Run Matrix</button></div>
    </div>
  </div>
  <div class="card" style="margin:8px 0;">
    <h2>Vendor Packs (optional)</h2>
    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start;">
      <div class="col"><div class="label">Emitter</div><select id="packs-emitter" multiple size="6" style="min-width:260px;"></select></div>
      <div class="col"><div class="label">Optics</div><select id="packs-optics" multiple size="6" style="min-width:260px;"></select></div>
      <div class="col"><div class="label">Sensor (PD)</div><select id="packs-sensor" multiple size="6" style="min-width:260px;"></select></div>
      <div class="col"><div class="label">TIA</div><select id="packs-tia" multiple size="6" style="min-width:260px;"></select></div>
      <div class="col"><div class="label">Comparator</div><select id="packs-comparator" multiple size="6" style="min-width:260px;"></select></div>
      <div class="col"><div class="label">Camera</div><select id="packs-camera" multiple size="6" style="min-width:260px;"></select></div>
      <div class="col"><div class="label">Clock</div><select id="packs-clock" multiple size="6" style="min-width:260px;"></select></div>
      <div class="col"><div class="label">Thermal</div><select id="packs-thermal" multiple size="6" style="min-width:260px;"></select></div>
    </div>
    <p style="font-size:12px;color:#9ca3af;">Tip: leave all empty to use defaults. Multi-select to build a matrix of vendor combinations.</p>
  </div>

  <div class="card" style="margin:8px 0;">
    <h2>Worker Log</h2>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
      <span>Connection:</span>
      <span id="conn" style="width:10px;height:10px;border-radius:50%;background:#4b5563;display:inline-block;"></span>
      <span id="connText" style="font-size:12px;color:#9ca3af;">Inactive</span>
    </div>
    <pre id="log" style="white-space:pre-wrap;height:160px;overflow:auto;border:1px solid var(--border);padding:8px;background:#0b1220;"></pre>
  </div>

  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h2>Summary KPIs</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
        <label title="Choose which variant's KPIs to display in Summary">
          Variant
          <select id="variant-select" style="min-width:220px;"></select>
        </label>
      </div>
      <table id="table-summary"></table>
    </div>
    <div class="card">
      <h2>Variants (click to focus)</h2>
      <div id="variant-bar" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
      <h2>Path A vs Path B</h2>
      <table id="table-paths"></table>
    </div>
    <div class="card">
      <h2>Input Path Comparison</h2>
      <table id="table-inputs"></table>
    </div>
    <div class="card">
      <h2>Realism Heuristics</h2>
      <table id="table-realism"></table>
    </div>
    <div class="card">
      <h2>Per-Component BER Attribution</h2>
      <table id="table-components"></table>
    </div>
    <div class="card">
      <h2>Calibrated Baseline KPIs</h2>
      <table id="table-calibrated"></table>
    </div>
    <div class="card">
      <h2>Per-tile BER</h2>
      <canvas id="tileHeat"></canvas>
    </div>
    <div class="card">
      <h2>Per-tile BER (after calibration)</h2>
      <canvas id="tileHeatAfter"></canvas>
    </div>
    <div class="card">
      <h2>Window Sweep (p50 BER)</h2>
      <canvas id="winChart"></canvas>
    </div>
    <div class="card">
      <h2>Voting & Calibration</h2>
      <table id="table-calib"></table>
    </div>
    <div class="card">
      <h2>Diag Crosstalk Sweep</h2>
      <canvas id="diagChart"></canvas>
    </div>
    <div class="card">
      <h2>Drift vs Time</h2>
      <canvas id="driftChart"></canvas>
    </div>
    <div class="card">
      <h2>Autotuner Result</h2>
      <table id="table-autotune"></table>
    </div>
    <div class="card">
      <h2>Best-of (across Matrix Runs)</h2>
      <table id="table-bestof"></table>
    </div>
    <div class="card">
      <h2>History & Filters</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;flex-wrap:wrap;">
        <label>Since (epoch s) <input id="hist-since" type="number" style="width:140px;"/></label>
        <label>Pack contains <input id="hist-pack" type="text" style="width:220px;"/></label>
        <label>Status
          <select id="hist-status"><option value="">any</option><option>ok</option><option>warn</option><option>fail</option></select>
        </label>
        <label>Limit <input id="hist-limit" type="number" value="50" style="width:80px;"/></label>
        <button id="btn-load-history">Load</button>
        <button id="btn-best-csv">Export Best CSV</button>
        <button id="btn-all-csv">Export All Runs CSV</button>
        <button id="btn-reset-history" style="margin-left:auto;background:#7f1d1d;border-color:#991b1b;">Reset History</button>
      </div>
      <table id="table-history"></table>
    </div>
    <div class="card">
      <h2>System Diagram</h2>
      <div class="diagram">
        <div class="box">Emitter</div><div class="arrow">→</div>
        <div class="box">Optics</div><div class="arrow">→</div>
        <div class="box">Camera</div><div class="arrow">→</div>
        <div class="box">TIA</div><div class="arrow">→</div>
        <div class="box">Comparator</div>
      </div>
      <p style="font-size:12px;color:#555;">Clock controls window & jitter. Thermal drift perturbs comparator threshold and optics transmittance.</p>
    </div>
    <div class="card">
      <h2>Pack Parameters</h2>
      <table id="table-packs"></table>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    let winChart, diagChart, driftChart, tileChartA, tileChartB;
    let collectedRuns = [];

    function getRunLabel(run) {
      try {
        const L = run.__label || {};
        const packs = (L.packs || {});
        const diffs = [];
        // defaults
        const def = { input: 'digital', sensitivity: false, output: 'path_a', window_ns: 20, analog_depth: 5 };
        if ((L.input||'digital') !== def.input) diffs.push(L.input === 'cold' ? 'cold' : String(L.input));
        if ((!!L.sensitivity) !== def.sensitivity) diffs.push('sens');
        if ((L.output||'path_a') !== def.output) {
          const d = (L.analog_depth!=null?`d=${L.analog_depth}`:'');
          diffs.push(L.output === 'path_b_analog' ? `pathB${d?`(${d})`:''}` : String(L.output));
        }
        const w = (L.window_ns!=null?Number(L.window_ns):null);
        if (w!=null && Math.round(w) !== def.window_ns) diffs.push(`w=${Math.round(w)}ns`);
        // include notable vendor overrides (non-typ)
        const base = (p)=>{ if(!p) return 'typ'; const s = p.split(/[\\/]/).pop()||''; return s.replace(/\.yaml$/,''); };
        const notable = [];
        ['tia','comparator','camera','emitter','optics','sensor','clock','thermal'].forEach(k=>{
          const b = base(packs[k]);
          if (b && !b.endsWith('_typ')) notable.push(`${k}=${b}`);
        });
        const core = diffs.length ? diffs.join(', ') : 'default';
        return notable.length ? `${core} | ${notable.join(', ')}` : core;
      } catch { return 'run'; }
    }

    function extractPrimaryBer(run) {
      try {
        const out = run.__label?.output;
        if (out === 'path_a') {
          return run?.path_a?.p50_ber ?? run?.baseline?.p50_ber ?? run?.p50_ber ?? null;
        }
        if (out === 'path_b_analog') {
          return run?.path_b?.analog_p50_ber ?? run?.path_b?.p50_ber ?? run?.baseline?.p50_ber ?? null;
        }
        // fallback
        return run?.baseline?.p50_ber ?? run?.p50_ber ?? null;
      } catch { return null; }
    }

    function updateBestOf() {
      const rows = [];
      if (!Array.isArray(collectedRuns) || collectedRuns.length === 0) {
        document.getElementById('table-bestof').innerHTML = '';
        return;
      }
      let bestOverall = { ber: Infinity, label: '' };
      let bestPathA = { ber: Infinity, label: '' };
      let bestPathB = { ber: Infinity, label: '' };
      let bestCold = { ber: Infinity, label: '' };
      let bestDigital = { ber: Infinity, label: '' };

      for (const r of collectedRuns) {
        const label = getRunLabel(r);
        const ber = extractPrimaryBer(r);
        if (typeof ber === 'number') {
          if (ber < bestOverall.ber) bestOverall = { ber, label };
        }
        const out = r.__label?.output;
        const inp = r.__label?.input;
        const berA = r?.path_a?.p50_ber ?? r?.baseline?.p50_ber;
        const berB = r?.path_b?.analog_p50_ber ?? r?.path_b?.p50_ber;
        if (typeof berA === 'number' && berA < bestPathA.ber) bestPathA = { ber: berA, label };
        if (typeof berB === 'number' && berB < bestPathB.ber) bestPathB = { ber: berB, label };
        if (inp === 'cold' && typeof ber === 'number' && ber < bestCold.ber) bestCold = { ber, label };
        if (inp === 'digital' && typeof ber === 'number' && ber < bestDigital.ber) bestDigital = { ber, label };
      }

      const table = document.getElementById('table-bestof');
      const obj = {
        best_overall_p50_ber: bestOverall.ber === Infinity ? 'N/A' : bestOverall.ber,
        best_overall_label: bestOverall.label || 'N/A',
        best_path_a_p50_ber: bestPathA.ber === Infinity ? 'N/A' : bestPathA.ber,
        best_path_a_label: bestPathA.label || 'N/A',
        best_path_b_analog_p50_ber: bestPathB.ber === Infinity ? 'N/A' : bestPathB.ber,
        best_path_b_analog_label: bestPathB.label || 'N/A',
        best_cold_input_p50_ber: bestCold.ber === Infinity ? 'N/A' : bestCold.ber,
        best_cold_input_label: bestCold.label || 'N/A',
        best_digital_input_p50_ber: bestDigital.ber === Infinity ? 'N/A' : bestDigital.ber,
        best_digital_input_label: bestDigital.label || 'N/A',
      };
      renderTable(table, obj);
    }

    function safeDestroy(ch) {
      try { if (ch && typeof ch.destroy === 'function') ch.destroy(); } catch (e) {}
    }

    function renderTable(table, obj) {
      const keys = Object.keys(obj || {});
      let html = '<tr><th>Key</th><th>Value</th></tr>';
      for (const k of keys) {
        let v = obj[k];
        if (typeof v === 'object') v = JSON.stringify(v);
        html += `<tr><td>${k}</td><td>${v}</td></tr>`;
      }
      table.innerHTML = html;
    }

    function renderRowsTable(table, rows) {
      const cols = ["__time","__run_id","__label","baseline.p50_ber","path_a.p50_ber","path_b.analog_p50_ber","__preflight.status"];
      let html = '<tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr>';
      for (const r of rows || []) {
        const cells = [];
        const t = r.__time ? new Date(r.__time*1000).toISOString().replace('T',' ').replace('Z','') : '';
        cells.push(t);
        cells.push(r.__run_id || '');
        cells.push(JSON.stringify(r.__label||{}));
        cells.push(String(r?.baseline?.p50_ber ?? ''));
        cells.push(String(r?.path_a?.p50_ber ?? ''));
        cells.push(String(r?.path_b?.analog_p50_ber ?? ''));
        cells.push(String(r?.__preflight?.status ?? ''));
        html += '<tr>' + cells.map(x=>`<td>${x}</td>`).join('') + '</tr>';
      }
      table.innerHTML = html;
    }

    function renderPacks(table, packs) {
      let html = '<tr><th>Pack</th><th>Params</th></tr>';
      for (const [name, vals] of Object.entries(packs || {})) {
        html += `<tr><td>${name}</td><td><pre style="white-space:pre-wrap;">${JSON.stringify(vals, null, 2)}</pre></td></tr>`;
      }
      table.innerHTML = html;
    }

    function drawHeatmap(canvas, existingChart, matrix) {
      if (!matrix || !Array.isArray(matrix) || matrix.length === 0 || !Array.isArray(matrix[0])) {
        return existingChart || null;
      }
      safeDestroy(existingChart);
      // Flatten matrix into dataset per row; color via gradient plugin surrogate (Chart.js lacks heatmap natively)
      // We'll approximate using stacked bar per column with opacity by value.
      const labels = matrix[0].map((_, i) => 'x'+i);
      const datasets = matrix.map((row, r) => ({
        label: 'y'+r,
        data: row,
        backgroundColor: row.map(v => `rgba(33,150,243,${Math.min(1, Math.max(0.05, v))})`),
        borderWidth: 0
      }));
      const chart = new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          scales: { x: { stacked: true }, y: { stacked: true, suggestedMax: 1.0 } },
          plugins: { legend: { display: false } }
        }
      });
      return chart;
    }

    function drawLine(canvas, existingChart, xs, ys, label) {
      if (!Array.isArray(xs) || !Array.isArray(ys) || xs.length === 0 || ys.length === 0) {
        return existingChart || null;
      }
      safeDestroy(existingChart);
      const chart = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: { labels: xs, datasets: [{ label, data: ys, borderColor: '#4caf50', fill: false }] },
        options: { responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 1 } } }
      });
      return chart;
    }

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          renderTable(document.getElementById('table-summary'), {
            p50_ber: data?.baseline?.p50_ber,
            p50_energy_pj: data?.baseline?.p50_energy_pj,
            window_ns: data?.baseline?.window_ns,
            p50_snr_emit: data?.baseline?.p50_snr_emit,
            p50_snr_pd: data?.baseline?.p50_snr_pd,
            p50_snr_tia: data?.baseline?.p50_snr_tia,
          });
          renderTable(document.getElementById('table-realism'), (data?.realism)||{});
          renderTable(document.getElementById('table-components'), (data?.components)||{});
          const variants = [];
          variants.push({ key:'baseline', label:'Baseline (Digital, Path A)', present: !!data?.baseline });
          variants.push({ key:'cold_input', label:'Cold input (Path A)', present: !!data?.cold_input });
          variants.push({ key:'path_b', label:'Path B (baseline)', present: !!data?.path_b });
          variants.push({ key:'path_b_analog', label:'Path B (analog cascade)', present: !!data?.path_b?.analog_p50_ber });
          const bar = document.getElementById('variant-bar');
          bar.innerHTML = '';
          const sel = document.getElementById('variant-select');
          sel.innerHTML = '';
          const present = variants.filter(v=>v.present);
          present.forEach(v => {
            const b = document.createElement('button');
            b.textContent = v.label;
            b.style.padding = '4px 8px';
            b.onclick = () => {
              window.__focusVariant = v.key;
              // re-render summary tables according to selected variant if needed
              let base = null;
              if (v.key === 'cold_input') base = data?.cold_input;
              else if (v.key === 'path_b' || v.key === 'path_b_analog') base = data?.path_b;
              else base = data?.baseline;
              if (base) renderTable(document.getElementById('table-summary'), {
                p50_ber: base?.p50_ber ?? 'N/A',
                p50_energy_pj: base?.p50_energy_pj ?? 'N/A',
                window_ns: base?.window_ns ?? 'N/A',
                p50_snr_emit: base?.p50_snr_emit ?? 'N/A',
                p50_snr_pd: base?.p50_snr_pd ?? 'N/A',
                p50_snr_tia: base?.p50_snr_tia ?? 'N/A',
              });
            };
            bar.appendChild(b);
            const opt = document.createElement('option');
            opt.value = v.key;
            opt.textContent = v.label;
            sel.appendChild(opt);
          });
          if (present.length) {
            sel.onchange = () => {
              const key = sel.value;
              window.__focusVariant = key;
              let base = null;
              if (key === 'cold_input') base = data?.cold_input;
              else if (key === 'path_b' || key === 'path_b_analog') base = data?.path_b;
              else base = data?.baseline;
              if (base) renderTable(document.getElementById('table-summary'), {
                p50_ber: base?.p50_ber ?? 'N/A',
                p50_energy_pj: base?.p50_energy_pj ?? 'N/A',
                window_ns: base?.window_ns ?? 'N/A',
                p50_snr_emit: base?.p50_snr_emit ?? 'N/A',
                p50_snr_pd: base?.p50_snr_pd ?? 'N/A',
                p50_snr_tia: base?.p50_snr_tia ?? 'N/A',
              });
            };
            sel.value = present[0].key;
            sel.onchange();
          }
          if (data?.path_a || data?.path_b) {
            renderTable(document.getElementById('table-paths'), {
              path_a_p50_ber: data?.path_a?.p50_ber ?? 'N/A',
              path_b_p50_ber: data?.path_b?.p50_ber ?? 'N/A',
              path_b_chain_depth: data?.path_b_chain?.depth,
              path_b_chain_p50_ber_vs_prev: data?.path_b_chain?.per_stage_p50_ber_vs_prev,
              path_b_chain_p50_ber_vs_initial: data?.path_b_chain?.per_stage_p50_ber_vs_initial,
              path_b_sweep_amp_gain_db: data?.path_b_sweeps?.amp_gain_db,
              path_b_sweep_p50_ber_vs_gain: data?.path_b_sweeps?.p50_ber_vs_gain,
              path_b_sweep_sat_I_sat: data?.path_b_sweeps?.sat_I_sat,
              path_b_sweep_p50_ber_vs_isat: data?.path_b_sweeps?.p50_ber_vs_isat,
            });
          }
          if (data?.cold_input || data?.baseline) {
            renderTable(document.getElementById('table-inputs'), {
              dlp_input_p50_ber: data?.baseline?.p50_ber ?? 'N/A',
              cold_input_p50_ber: data?.cold_input?.p50_ber ?? 'N/A',
              cold_input_window_ns: data?.cold_input?.window_ns ?? 'N/A',
            });
          }
          renderTable(document.getElementById('table-calibrated'), {
            p50_ber: data?.baseline_calibrated?.p50_ber,
            p50_energy_pj: data?.baseline_calibrated?.p50_energy_pj,
            window_ns: data?.baseline_calibrated?.window_ns,
            p50_snr_emit: data?.baseline_calibrated?.p50_snr_emit,
            p50_snr_pd: data?.baseline_calibrated?.p50_snr_pd,
            p50_snr_tia: data?.baseline_calibrated?.p50_snr_tia,
          });
          renderPacks(document.getElementById('table-packs'), data?.packs || {});
          try {
            const hm = data?.ber_per_tile;
            tileChartA = drawHeatmap(document.getElementById('tileHeat'), tileChartA, hm);
          } catch {}
          try {
            const hma = data?.ber_per_tile_after;
            tileChartB = drawHeatmap(document.getElementById('tileHeatAfter'), tileChartB, hma);
          } catch {}
          try {
            const xs = data?.window_sweep?.x_window_ns || [];
            const ys = data?.window_sweep?.p50_ber || [];
            winChart = drawLine(document.getElementById('winChart'), winChart, xs, ys, 'p50 BER');
          } catch {}
          try {
            const dx = data?.sensitivity?.diag_crosstalk_sweep?.x_ct_diag_db || [];
            const dy = data?.sensitivity?.diag_crosstalk_sweep?.p50_ber || [];
            diagChart = drawLine(document.getElementById('diagChart'), diagChart, dx, dy, 'p50 BER vs ct_diag_db');
          } catch {}
          const dno = data?.drift?.no_cal || {};
          const dfix = data?.drift?.with_cal || {};
          if ((dno?.x_frame?.length||0) && (dfix?.x_frame?.length||0)) {
            const ctx = document.getElementById('driftChart').getContext('2d');
            safeDestroy(driftChart);
            driftChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: dno.x_frame,
                datasets: [
                  { label: 'No Cal', data: dno.p50_ber, borderColor: '#f44336', fill: false },
                  { label: 'With Cal', data: dfix.p50_ber, borderColor: '#2196f3', fill: false }
                ]
              },
              options: { responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 1 } } }
            });
          }
          renderTable(document.getElementById('table-calib'), {
            vote3_p50_ber: data?.vote3_p50_ber,
            spatial_oversample_p50_ber: data?.spatial_oversample_p50_ber,
            lockin_p50_ber: data?.lockin_p50_ber,
            chop_p50_ber: data?.chop_p50_ber,
            avg_frames_p50_ber: data?.avg_frames_p50_ber,
            soft_thresh_p50_ber: data?.soft_thresh_p50_ber,
            mitigated_p50_ber: data?.mitigated_p50_ber,
            vth_suggest_mV: data?.calibration?.vth_suggest_mV,
            ber_before: data?.calibration?.ber_before,
            ber_after: data?.calibration?.ber_after,
            ber_delta: data?.calibration?.ber_delta,
          });
          if (data?.autotune) {
            renderTable(document.getElementById('table-autotune'), {
              best_ber: data.autotune.best_ber,
              best_summary: JSON.stringify(data.autotune.best_summary),
              tuned_clock_window_ns: data.autotune.params?.clock?.window_ns,
              tuned_emitter_power_mw_per_ch: data.autotune.params?.emitter?.power_mw_per_ch,
              tuned_tia_gain_kohm: data.autotune.params?.tia?.tia_transimpedance_kohm,
              tuned_tia_bw_mhz: data.autotune.params?.tia?.bw_mhz,
              tuned_comp_hysteresis_mV: data.autotune.params?.comparator?.hysteresis_mV,
              tuned_optics_ct_db: data.autotune.params?.optics?.crosstalk_db,
              tuned_optics_ct_neighbor_db: data.autotune.params?.optics?.ct_neighbor_db,
              tuned_optics_ct_diag_db: data.autotune.params?.optics?.ct_diag_db,
            });
          }
        } catch (err) {
          alert('Invalid JSON');
        }
      };
      reader.readAsText(f);
    });

    // Retest controls
    const logEl = document.getElementById('log');
    function appendLog(obj) {
      logEl.textContent += (typeof obj === 'string' ? obj : JSON.stringify(obj)) + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }
    const evtSrc = new EventSource('/api/events');
    evtSrc.onmessage = (ev) => {
      try {
        const data = JSON.parse(ev.data);
        if (data.msg === 'connected') {
          document.getElementById('conn').style.background = '#4caf50';
          document.getElementById('connText').textContent = 'Active';
          return;
        }
        if (data.ping) return; // quiet heartbeat
        appendLog(data);
      } catch { appendLog(ev.data); }
    };
    evtSrc.addEventListener('done', (ev) => {
      try {
        const data = JSON.parse(ev.data);
        if (data.__run_id) {
          // Matrix run result: collect and append to select, auto-render latest
          collectedRuns.push(data);
          const sel = document.getElementById('variant-select');
          const label = getRunLabel(data);
          const opt = document.createElement('option');
          opt.value = `run:${data.__run_id}`;
          opt.textContent = label;
          sel.appendChild(opt);
          sel.value = `run:${data.__run_id}`;
          // render immediately across panels
          renderTable(document.getElementById('table-summary'), {
            p50_ber: data?.baseline?.p50_ber ?? data?.p50_ber ?? 'N/A',
            p50_energy_pj: data?.baseline?.p50_energy_pj ?? data?.p50_energy_pj ?? 'N/A',
            window_ns: data?.baseline?.window_ns ?? data?.window_ns ?? 'N/A',
            p50_snr_emit: data?.baseline?.p50_snr_emit ?? data?.p50_snr_emit ?? 'N/A',
            p50_snr_pd: data?.baseline?.p50_snr_pd ?? data?.p50_snr_pd ?? 'N/A',
            p50_snr_tia: data?.baseline?.p50_snr_tia ?? data?.p50_snr_tia ?? 'N/A',
          });
          renderTable(document.getElementById('table-realism'), (data?.realism)||{});
          renderTable(document.getElementById('table-components'), (data?.components)||{});
          renderTable(document.getElementById('table-paths'), {
            path_a_p50_ber: data?.path_a?.p50_ber ?? 'N/A',
            path_b_p50_ber: data?.path_b?.p50_ber ?? 'N/A',
            path_b_chain_depth: data?.path_b_chain?.depth ?? 'N/A',
            path_b_chain_p50_ber_vs_prev: data?.path_b_chain?.per_stage_p50_ber_vs_prev ?? 'N/A',
            path_b_chain_p50_ber_vs_initial: data?.path_b_chain?.per_stage_p50_ber_vs_initial ?? 'N/A',
            path_b_analog_depth: data?.path_b?.analog_depth ?? 'N/A',
            path_b_analog_p50_ber: data?.path_b?.analog_p50_ber ?? 'N/A',
          });
          renderTable(document.getElementById('table-inputs'), {
            dlp_input_p50_ber: data?.baseline?.p50_ber ?? 'N/A',
            cold_input_p50_ber: data?.cold_input?.p50_ber ?? 'N/A',
            cold_input_window_ns: data?.cold_input?.window_ns ?? 'N/A',
          });
          renderTable(document.getElementById('table-calibrated'), {
            p50_ber: data?.baseline_calibrated?.p50_ber,
            p50_energy_pj: data?.baseline_calibrated?.p50_energy_pj,
            window_ns: data?.baseline_calibrated?.window_ns,
            p50_snr_emit: data?.baseline_calibrated?.p50_snr_emit,
            p50_snr_pd: data?.baseline_calibrated?.p50_snr_pd,
            p50_snr_tia: data?.baseline_calibrated?.p50_snr_tia,
          });
          // Packs
          try { renderPacks(document.getElementById('table-packs'), data?.packs || {}); } catch {}
          try { tileChartA = drawHeatmap(document.getElementById('tileHeat'), tileChartA, data?.ber_per_tile); } catch {}
          try { tileChartB = drawHeatmap(document.getElementById('tileHeatAfter'), tileChartB, data?.ber_per_tile_after); } catch {}
          try {
            const xs = data?.window_sweep?.x_window_ns || [];
            const ys = data?.window_sweep?.p50_ber || [];
            winChart = drawLine(document.getElementById('winChart'), winChart, xs, ys, 'p50 BER');
          } catch {}
          // Diag crosstalk sweep (sensitivity block)
          try {
            const dx = data?.sensitivity?.diag_crosstalk_sweep?.x_ct_diag_db || [];
            const dy = data?.sensitivity?.diag_crosstalk_sweep?.p50_ber || [];
            diagChart = drawLine(document.getElementById('diagChart'), diagChart, dx, dy, 'p50 BER vs ct_diag_db');
          } catch {}
          // Drift vs time
          try {
            const dno = data?.drift?.no_cal || {};
            const dfix = data?.drift?.with_cal || {};
            if ((dno?.x_frame?.length||0) && (dfix?.x_frame?.length||0)) {
              const ctx = document.getElementById('driftChart').getContext('2d');
              safeDestroy(driftChart);
              driftChart = new Chart(ctx, {
                type: 'line',
                data: { labels: dno.x_frame, datasets: [
                  { label: 'No Cal', data: dno.p50_ber, borderColor: '#f44336', fill: false },
                  { label: 'With Cal', data: dfix.p50_ber, borderColor: '#2196f3', fill: false },
                ]},
                options: { responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 1 } } }
              });
            }
          } catch {}
          // Autotuner results
          if (data?.autotune) {
            renderTable(document.getElementById('table-autotune'), {
              best_ber: data.autotune.best_ber,
              best_summary: JSON.stringify(data.autotune.best_summary),
              tuned_clock_window_ns: data.autotune.params?.clock?.window_ns,
              tuned_emitter_power_mw_per_ch: data.autotune.params?.emitter?.power_mw_per_ch,
              tuned_tia_gain_kohm: data.autotune.params?.tia?.tia_transimpedance_kohm,
              tuned_tia_bw_mhz: data.autotune.params?.tia?.bw_mhz,
              tuned_comp_hysteresis_mV: data.autotune.params?.comparator?.hysteresis_mV,
              tuned_optics_ct_db: data.autotune.params?.optics?.crosstalk_db,
              tuned_optics_ct_neighbor_db: data.autotune.params?.optics?.ct_neighbor_db,
              tuned_optics_ct_diag_db: data.autotune.params?.optics?.ct_diag_db,
            });
          }
          renderTable(document.getElementById('table-calib'), {
            vote3_p50_ber: data?.vote3_p50_ber,
            spatial_oversample_p50_ber: data?.spatial_oversample_p50_ber,
            lockin_p50_ber: data?.lockin_p50_ber,
            chop_p50_ber: data?.chop_p50_ber,
            avg_frames_p50_ber: data?.avg_frames_p50_ber,
            soft_thresh_p50_ber: data?.soft_thresh_p50_ber,
            mitigated_p50_ber: data?.mitigated_p50_ber,
            vth_suggest_mV: data?.calibration?.vth_suggest_mV,
            ber_before: data?.calibration?.ber_before,
            ber_after: data?.calibration?.ber_after,
            ber_delta: data?.calibration?.ber_delta,
          });
          // update best-of
          updateBestOf();
          return;
        }
        // Auto-load the finished JSON
        renderTable(document.getElementById('table-summary'), {
          p50_ber: data?.baseline?.p50_ber ?? 'N/A',
          p50_energy_pj: data?.baseline?.p50_energy_pj ?? 'N/A',
          window_ns: data?.baseline?.window_ns ?? 'N/A',
          p50_snr_emit: data?.baseline?.p50_snr_emit ?? 'N/A',
          p50_snr_pd: data?.baseline?.p50_snr_pd ?? 'N/A',
          p50_snr_tia: data?.baseline?.p50_snr_tia ?? 'N/A',
        });
        renderTable(document.getElementById('table-realism'), (data?.realism)||{});
        // Build/refresh variants bar
        const variants = [];
        variants.push({ key:'baseline', label:'Baseline (Digital, Path A)', present: !!data?.baseline });
        variants.push({ key:'cold_input', label:'Cold input (Path A)', present: !!data?.cold_input });
        variants.push({ key:'path_b', label:'Path B (baseline)', present: !!data?.path_b });
        variants.push({ key:'path_b_analog', label:'Path B (analog cascade)', present: !!data?.path_b?.analog_p50_ber });
        const bar = document.getElementById('variant-bar');
        bar.innerHTML = '';
        const sel = document.getElementById('variant-select');
        sel.innerHTML = '';
        const present = variants.filter(v=>v.present);
        present.forEach(v => {
          const b = document.createElement('button');
          b.textContent = v.label;
          b.style.padding = '4px 8px';
          b.onclick = () => {
            window.__focusVariant = v.key;
            const base = (v.key==='cold_input') ? data?.cold_input : data?.baseline;
            if (base) renderTable(document.getElementById('table-summary'), {
              p50_ber: base?.p50_ber ?? 'N/A',
              p50_energy_pj: base?.p50_energy_pj ?? 'N/A',
              window_ns: base?.window_ns ?? 'N/A',
              p50_snr_emit: base?.p50_snr_emit ?? 'N/A',
              p50_snr_pd: base?.p50_snr_pd ?? 'N/A',
              p50_snr_tia: base?.p50_snr_tia ?? 'N/A',
            });
          };
          bar.appendChild(b);
          const opt = document.createElement('option');
          opt.value = v.key;
          opt.textContent = v.label;
          sel.appendChild(opt);
        });
        if (present.length) {
          sel.onchange = () => {
            const key = sel.value;
            window.__focusVariant = key;
            const base = (key==='cold_input') ? data?.cold_input : data?.baseline;
            if (base) renderTable(document.getElementById('table-summary'), {
              p50_ber: base?.p50_ber ?? 'N/A',
              p50_energy_pj: base?.p50_energy_pj ?? 'N/A',
              window_ns: base?.window_ns ?? 'N/A',
              p50_snr_emit: base?.p50_snr_emit ?? 'N/A',
              p50_snr_pd: base?.p50_snr_pd ?? 'N/A',
              p50_snr_tia: base?.p50_snr_tia ?? 'N/A',
            });
          };
          sel.value = present[0].key;
          sel.onchange();
        }
        if (data?.path_a || data?.path_b) {
          renderTable(document.getElementById('table-paths'), {
            path_a_p50_ber: data?.path_a?.p50_ber ?? 'N/A',
            path_b_p50_ber: data?.path_b?.p50_ber ?? 'N/A',
            path_b_chain_depth: data?.path_b_chain?.depth ?? 'N/A',
            path_b_chain_p50_ber_vs_prev: data?.path_b_chain?.per_stage_p50_ber_vs_prev ?? 'N/A',
            path_b_chain_p50_ber_vs_initial: data?.path_b_chain?.per_stage_p50_ber_vs_initial ?? 'N/A',
            path_b_analog_depth: data?.path_b?.analog_depth ?? 'N/A',
            path_b_analog_p50_ber: data?.path_b?.analog_p50_ber ?? 'N/A',
            path_b_sweep_amp_gain_db: data?.path_b_sweeps?.amp_gain_db ?? 'N/A',
            path_b_sweep_p50_ber_vs_gain: data?.path_b_sweeps?.p50_ber_vs_gain ?? 'N/A',
            path_b_sweep_sat_I_sat: data?.path_b_sweeps?.sat_I_sat ?? 'N/A',
            path_b_sweep_p50_ber_vs_isat: data?.path_b_sweeps?.p50_ber_vs_isat ?? 'N/A',
          });
        }
        if (data?.cold_input || data?.baseline) {
          renderTable(document.getElementById('table-inputs'), {
            dlp_input_p50_ber: data?.baseline?.p50_ber ?? 'N/A',
            cold_input_p50_ber: data?.cold_input?.p50_ber ?? 'N/A',
            cold_input_window_ns: data?.cold_input?.window_ns ?? 'N/A',
          });
        }
        renderTable(document.getElementById('table-calibrated'), {
          p50_ber: data?.baseline_calibrated?.p50_ber,
          p50_energy_pj: data?.baseline_calibrated?.p50_energy_pj,
          window_ns: data?.baseline_calibrated?.window_ns,
          p50_snr_emit: data?.baseline_calibrated?.p50_snr_emit,
          p50_snr_pd: data?.baseline_calibrated?.p50_snr_pd,
          p50_snr_tia: data?.baseline_calibrated?.p50_snr_tia,
        });
        try {
          const hm = data?.ber_per_tile;
          tileChartA = drawHeatmap(document.getElementById('tileHeat'), tileChartA, hm);
        } catch {}
        try {
          const hma = data?.ber_per_tile_after;
          tileChartB = drawHeatmap(document.getElementById('tileHeatAfter'), tileChartB, hma);
        } catch {}
        try {
          const xs = data?.window_sweep?.x_window_ns || [];
          const ys = data?.window_sweep?.p50_ber || [];
          winChart = drawLine(document.getElementById('winChart'), winChart, xs, ys, 'p50 BER');
        } catch {}
        renderTable(document.getElementById('table-calib'), {
          vote3_p50_ber: data?.vote3_p50_ber,
          spatial_oversample_p50_ber: data?.spatial_oversample_p50_ber,
          lockin_p50_ber: data?.lockin_p50_ber,
          chop_p50_ber: data?.chop_p50_ber,
          avg_frames_p50_ber: data?.avg_frames_p50_ber,
          soft_thresh_p50_ber: data?.soft_thresh_p50_ber,
          mitigated_p50_ber: data?.mitigated_p50_ber,
          vth_suggest_mV: data?.calibration?.vth_suggest_mV,
          ber_before: data?.calibration?.ber_before,
          ber_after: data?.calibration?.ber_after,
          ber_delta: data?.calibration?.ber_delta,
        });
        if (data?.autotune) {
          renderTable(document.getElementById('table-autotune'), {
            best_ber: data.autotune.best_ber,
            tuned_clock_window_ns: data.autotune.params?.clock?.window_ns,
            tuned_emitter_power_mw_per_ch: data.autotune.params?.emitter?.power_mw_per_ch,
            tuned_tia_gain_kohm: data.autotune.params?.tia?.tia_transimpedance_kohm,
            tuned_tia_bw_mhz: data.autotune.params?.tia?.bw_mhz,
            tuned_comp_hysteresis_mV: data.autotune.params?.comparator?.hysteresis_mV,
            tuned_optics_ct_db: data.autotune.params?.optics?.crosstalk_db,
            tuned_optics_ct_neighbor_db: data.autotune.params?.optics?.ct_neighbor_db,
            tuned_optics_ct_diag_db: data.autotune.params?.optics?.ct_diag_db,
          });
        }
        try {
          const dx = data?.sensitivity?.diag_crosstalk_sweep?.x_ct_diag_db || [];
          const dy = data?.sensitivity?.diag_crosstalk_sweep?.p50_ber || [];
          diagChart = drawLine(document.getElementById('diagChart'), diagChart, dx, dy, 'p50 BER vs ct_diag_db');
        } catch {}
        const dno = data?.drift?.no_cal || {};
        const dfix = data?.drift?.with_cal || {};
        if ((dno?.x_frame?.length||0) && (dfix?.x_frame?.length||0)) {
          const ctx = document.getElementById('driftChart').getContext('2d');
          new Chart(ctx, { type: 'line', data: { labels: dno.x_frame, datasets: [ { label: 'No Cal', data: dno.p50_ber, borderColor: '#f44336', fill: false }, { label: 'With Cal', data: dfix.p50_ber, borderColor: '#2196f3', fill: false } ] }, options: { responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 1 } } } });
        }
      } catch (e) { appendLog({ error: String(e) }); }
    });
    function firstOf(id) {
      const el = document.getElementById(id);
      const sel = Array.from(el.selectedOptions).map(o=>o.value);
      return sel[0];
    }
    function csvOf(id) {
      const el = document.getElementById(id);
      const sel = Array.from(el.selectedOptions).map(o=>o.value);
      return sel.join(',');
    }
    document.getElementById('btn-run').onclick = async () => {
      const trials = firstOf('ms-trials');
      const seed = firstOf('ms-seed');
      const windowNs = firstOf('ms-window');
      const vote = firstOf('ms-vote3') || '1';
      const auto = firstOf('ms-autotune') || '1';
      const sens = firstOf('ms-sensitivity') || '0';
      const neigh = firstOf('ms-neighbor') || '0';
      const adapt = firstOf('ms-adapt-flag') || '1';
      const pbd = firstOf('ms-pathb-depth');
      const adaptMax = firstOf('ms-adapt-max');
      const adaptMargin = firstOf('ms-margin');
      const path = firstOf('ms-path');
      const inputSrc = firstOf('ms-input');
      appendLog({ msg: 'requesting run' });
      try {
        const packArgs = new URLSearchParams();
        const map = {
          'packs-emitter': 'emitter_pack',
          'packs-optics': 'optics_pack',
          'packs-sensor': 'sensor_pack',
          'packs-tia': 'tia_pack',
          'packs-comparator': 'comparator_pack',
          'packs-camera': 'camera_pack',
          'packs-clock': 'clock_pack',
          'packs-thermal': 'thermal_pack',
        };
        Object.entries(map).forEach(([id, key]) => {
          const v = firstOf(id);
          if (v) packArgs.append(key, v);
        });
        const isPathB = (path === 'path_b_analog');
        const cold = (inputSrc === 'cold') ? '1':'0';
        const r = await fetch(`/api/run?trials=${trials}&seed=${seed}&base_window_ns=${windowNs}&vote3=${vote}&autotune=${auto}&sensitivity=${sens}&neighbor_ct=${neigh}&path_b=${isPathB?'1':'0'}&path_b_depth=${pbd}&path_b_sweep=0&path_b_analog_depth=${pbd}&path_b_analog=${isPathB?'1':'0'}&cold_input=${cold}&adaptive_input=${adapt}&adaptive_max_frames=${adaptMax}&adaptive_margin_mV=${adaptMargin}&${packArgs.toString()}`);
        appendLog(await r.json());
      } catch (err) { appendLog({ error: String(err) }); }
    };

    document.getElementById('btn-run-matrix').onclick = async () => {
      const trials = csvOf('ms-trials');
      const seed = csvOf('ms-seed');
      const windowNs = csvOf('ms-window');
      const depths = csvOf('ms-pathb-depth');
      const auto = csvOf('ms-autotune') || '1';
      const votes = csvOf('ms-vote3') || '1';
      const sens = csvOf('ms-sensitivity') || '0';
      const neigh = csvOf('ms-neighbor') || '0';
      const adapt = csvOf('ms-adapt-flag') || '1';
      const inputs = csvOf('ms-input');
      const outputs = csvOf('ms-path');
      appendLog({ msg: 'requesting matrix run' });
      try {
        // Build CSV lists from multi-selects
        const pickCSV = (id) => {
          const el = document.getElementById(id);
          if (!el) return '';
          const sel = Array.from(el.selectedOptions).map(o=>o.value);
          return encodeURIComponent(sel.join(','));
        };
        const cap = 96;
        const q = `emitter_packs=${pickCSV('packs-emitter')}&optics_packs=${pickCSV('packs-optics')}&sensor_packs=${pickCSV('packs-sensor')}&tia_packs=${pickCSV('packs-tia')}&comparator_packs=${pickCSV('packs-comparator')}&camera_packs=${pickCSV('packs-camera')}&clock_packs=${pickCSV('packs-clock')}&thermal_packs=${pickCSV('packs-thermal')}`;
        const r = await fetch(`/api/run_matrix?trials=${trials}&seed=${seed}&windows=${windowNs}&inputs=${inputs}&outputs=${outputs}&path_b_analog_depths=${depths}&autotune=${auto}&vote3=${votes}&sensitivity=${sens}&neighbor_ct=${neigh}&adaptive_input=${adapt}&adaptive_max_frames=${csvOf('ms-adapt-max')}&adaptive_margin_mV=${csvOf('ms-margin')}&cap=${cap}&${q}`);
        appendLog(await r.json());
      } catch (err) { appendLog({ error: String(err) }); }
    };

    document.getElementById('btn-load-history').onclick = async () => {
      const since = document.getElementById('hist-since').value || '';
      const pack = document.getElementById('hist-pack').value || '';
      const status = document.getElementById('hist-status').value || '';
      const limit = document.getElementById('hist-limit').value || '50';
      try {
        const r = await fetch(`/api/history?limit=${encodeURIComponent(limit)}&since=${encodeURIComponent(since)}&pack_contains=${encodeURIComponent(pack)}&status=${encodeURIComponent(status)}`);
        const data = await r.json();
        renderRowsTable(document.getElementById('table-history'), data.rows || []);
      } catch (e) { appendLog({ error: String(e) }); }
    };

    document.getElementById('btn-best-csv').onclick = async () => {
      const status = document.getElementById('hist-status').value || '';
      // group by all packs by default
      const qs = `status=${encodeURIComponent(status)}&group_by=emitter,optics,sensor,tia,comparator,camera,clock,thermal&format=csv`;
      try {
        const r = await fetch(`/api/history_best?${qs}`);
        const text = await r.text();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([text], {type:'text/csv'}));
        a.download = 'history_best.csv';
        a.click();
      } catch (e) { appendLog({ error: String(e) }); }
    };

    document.getElementById('btn-all-csv').onclick = async () => {
      const since = document.getElementById('hist-since').value || '';
      const pack = document.getElementById('hist-pack').value || '';
      const status = document.getElementById('hist-status').value || '';
      const limit = document.getElementById('hist-limit').value || '10000';
      try {
        const r = await fetch(`/api/history?format=csv&limit=${encodeURIComponent(limit)}&since=${encodeURIComponent(since)}&pack_contains=${encodeURIComponent(pack)}&status=${encodeURIComponent(status)}`);
        const text = await r.text();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([text], {type:'text/csv'}));
        a.download = 'history_all_runs.csv';
        a.click();
      } catch (e) { appendLog({ error: String(e) }); }
    };

    document.getElementById('btn-reset-history').onclick = async () => {
      if (!confirm('This will delete runs_history.jsonl. Continue?')) return;
      try {
        const r = await fetch('/api/history/reset', { method: 'POST' });
        appendLog(await r.json());
      } catch (e) { appendLog({ error: String(e) }); }
    };

    // Populate vendor packs and Run Config lists
    (async () => {
      try {
        const r = await fetch('/api/packs');
        const data = await r.json();
        const fill = (id, arr) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.innerHTML = '';
          (arr||[]).forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; el.appendChild(o); });
        };
        fill('packs-emitter', data.emitters || data.emitters || data.emitter || []);
        fill('packs-optics', data.optics || []);
        fill('packs-sensor', data.sensors || data.sensor || []);
        fill('packs-tia', data.tias || data.tia || []);
        fill('packs-comparator', data.comparators || data.comparator || []);
        fill('packs-camera', data.cameras || data.camera || []);
        fill('packs-clock', data.clocks || data.clock || []);
        fill('packs-thermal', data.thermal || []);
        // Run config defaults
        const trials = Array.from({length: 20}, (_,i)=> (50*(i+1))).map(x=>String(x));
        const seeds = ['123','321','42','777'];
        const windows = Array.from({length:50},(_,i)=>String(i+1));
        const depths = Array.from({length:50},(_,i)=>String(i+1));
        const adaptMax = Array.from({length:16},(_,i)=>String(i+1));
        const margins = Array.from({length:20},(_,i)=> (0.1*(i+1)).toFixed(1));
        const fillOpts = (id, arr, selIdxs=[0]) => { const el=document.getElementById(id); el.innerHTML=''; arr.forEach((v,idx)=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; if(selIdxs.includes(idx)) o.selected=true; el.appendChild(o); }); };
        fillOpts('ms-trials', trials, [5]);
        fillOpts('ms-seed', seeds, [0]);
        fillOpts('ms-window', windows, [19]);
        fillOpts('ms-pathb-depth', depths, [4]);
        fillOpts('ms-adapt-max', adaptMax, [11]);
        fillOpts('ms-margin', margins, [7]);
      } catch {}
    })();

    // Allow selecting any collected matrix run from the dropdown later
    document.getElementById('variant-select').addEventListener('change', () => {
      const sel = document.getElementById('variant-select');
      const val = sel.value || '';
      if (!val.startsWith('run:')) return; // handled elsewhere for static variants
      const runId = val.slice(4);
      const data = collectedRuns.find(r => r.__run_id === runId);
      if (!data) return;
      renderTable(document.getElementById('table-summary'), {
        p50_ber: data?.baseline?.p50_ber ?? data?.p50_ber ?? 'N/A',
        p50_energy_pj: data?.baseline?.p50_energy_pj ?? data?.p50_energy_pj ?? 'N/A',
        window_ns: data?.baseline?.window_ns ?? data?.window_ns ?? 'N/A',
        p50_snr_emit: data?.baseline?.p50_snr_emit ?? data?.p50_snr_emit ?? 'N/A',
        p50_snr_pd: data?.baseline?.p50_snr_pd ?? data?.p50_snr_pd ?? 'N/A',
        p50_snr_tia: data?.baseline?.p50_snr_tia ?? data?.p50_snr_tia ?? 'N/A',
      });
      renderTable(document.getElementById('table-realism'), (data?.realism)||{});
      renderTable(document.getElementById('table-components'), (data?.components)||{});
      renderTable(document.getElementById('table-paths'), {
        path_a_p50_ber: data?.path_a?.p50_ber ?? 'N/A',
        path_b_p50_ber: data?.path_b?.p50_ber ?? 'N/A',
        path_b_chain_depth: data?.path_b_chain?.depth ?? 'N/A',
        path_b_chain_p50_ber_vs_prev: data?.path_b_chain?.per_stage_p50_ber_vs_prev ?? 'N/A',
        path_b_chain_p50_ber_vs_initial: data?.path_b_chain?.per_stage_p50_ber_vs_initial ?? 'N/A',
        path_b_analog_depth: data?.path_b?.analog_depth ?? 'N/A',
        path_b_analog_p50_ber: data?.path_b?.analog_p50_ber ?? 'N/A',
      });
      renderTable(document.getElementById('table-inputs'), {
        dlp_input_p50_ber: data?.baseline?.p50_ber ?? 'N/A',
        cold_input_p50_ber: data?.cold_input?.p50_ber ?? 'N/A',
        cold_input_window_ns: data?.cold_input?.window_ns ?? 'N/A',
      });
      renderTable(document.getElementById('table-calibrated'), {
        p50_ber: data?.baseline_calibrated?.p50_ber,
        p50_energy_pj: data?.baseline_calibrated?.p50_energy_pj,
        window_ns: data?.baseline_calibrated?.window_ns,
        p50_snr_emit: data?.baseline_calibrated?.p50_snr_emit,
        p50_snr_pd: data?.baseline_calibrated?.p50_snr_pd,
        p50_snr_tia: data?.baseline_calibrated?.p50_snr_tia,
      });
      try { tileChartA = drawHeatmap(document.getElementById('tileHeat'), tileChartA, data?.ber_per_tile); } catch {}
      try { tileChartB = drawHeatmap(document.getElementById('tileHeatAfter'), tileChartB, data?.ber_per_tile_after); } catch {}
      try {
        const xs = data?.window_sweep?.x_window_ns || [];
        const ys = data?.window_sweep?.p50_ber || [];
        winChart = drawLine(document.getElementById('winChart'), winChart, xs, ys, 'p50 BER');
      } catch {}
      renderTable(document.getElementById('table-calib'), {
        vote3_p50_ber: data?.vote3_p50_ber,
        spatial_oversample_p50_ber: data?.spatial_oversample_p50_ber,
        lockin_p50_ber: data?.lockin_p50_ber,
        chop_p50_ber: data?.chop_p50_ber,
        avg_frames_p50_ber: data?.avg_frames_p50_ber,
        soft_thresh_p50_ber: data?.soft_thresh_p50_ber,
        mitigated_p50_ber: data?.mitigated_p50_ber,
        vth_suggest_mV: data?.calibration?.vth_suggest_mV,
        ber_before: data?.calibration?.ber_before,
        ber_after: data?.calibration?.ber_after,
        ber_delta: data?.calibration?.ber_delta,
      });
      updateBestOf();
    });
  </script>
</body>
</html>

